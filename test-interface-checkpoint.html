<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Interface Compl√®te - Point de Contr√¥le</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .test-summary {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        .summary-pass {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .summary-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        .summary-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #4caf50;
            transition: width 0.3s ease;
        }
        .section-header {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 15px 0 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Interface Compl√®te - Point de Contr√¥le</h1>
    
    <div class="test-container">
        <h2>Progression des Tests</h2>
        <div class="progress">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
        <div id="progress-text">Initialisation...</div>
    </div>

    <div class="test-container">
        <h2>R√©sultats des Tests d'Interface</h2>
        <div id="test-results"></div>
        <div id="test-summary" class="test-summary"></div>
    </div>

    <!-- Import des modules -->
    <script src="js/models/state.js"></script>
    <script src="js/calculators/ItemCalculator.js"></script>
    <script src="js/calculators/HourlyCalculator.js"></script>
    <script src="js/calculators/TotalCalculator.js"></script>
    <script src="js/managers/InvoiceManager.js"></script>
    <script src="js/managers/ThemeManager.js"></script>
    <script src="js/managers/CurrencyManager.js"></script>
    <script src="js/engines/PDFEngine.js"></script>
    <script src="js/engines/ImageEngine.js"></script>

    <script>
        class InterfaceTestRunner {
            constructor() {
                this.results = [];
                this.totalTests = 0;
                this.completedTests = 0;
                this.warnings = [];
            }

            updateProgress() {
                const percentage = (this.completedTests / this.totalTests) * 100;
                document.getElementById('progress-bar').style.width = percentage + '%';
                document.getElementById('progress-text').textContent = 
                    `${this.completedTests}/${this.totalTests} tests compl√©t√©s (${Math.round(percentage)}%)`;
            }

            addResult(name, status, message = null) {
                this.results.push({ name, status, message });
                this.completedTests++;
                this.updateProgress();
                this.displayLatestResult();
            }

            addWarning(message) {
                this.warnings.push(message);
            }

            displayLatestResult() {
                const result = this.results[this.results.length - 1];
                const resultsContainer = document.getElementById('test-results');
                
                const div = document.createElement('div');
                div.className = `test-result test-${result.status}`;
                
                let icon = '';
                switch(result.status) {
                    case 'pass': icon = '‚úì'; break;
                    case 'fail': icon = '‚úó'; break;
                    case 'warning': icon = '‚ö†'; break;
                }
                
                div.innerHTML = `${icon} ${result.name}${result.message ? `: ${result.message}` : ''}`;
                resultsContainer.appendChild(div);
                div.scrollIntoView({ behavior: 'smooth' });
            }

            displaySummary() {
                const passed = this.results.filter(r => r.status === 'pass').length;
                const failed = this.results.filter(r => r.status === 'fail').length;
                const warnings = this.results.filter(r => r.status === 'warning').length;
                
                const summaryContainer = document.getElementById('test-summary');
                summaryContainer.textContent = `Tests: ${this.results.length}, R√©ussis: ${passed}, √âchou√©s: ${failed}, Avertissements: ${warnings}`;
                
                if (failed > 0) {
                    summaryContainer.className = 'test-summary summary-fail';
                } else if (warnings > 0) {
                    summaryContainer.className = 'test-summary summary-warning';
                } else {
                    summaryContainer.className = 'test-summary summary-pass';
                }
            }

            testElementExists(selector, name) {
                const element = document.querySelector(selector);
                if (element) {
                    this.addResult(name, 'pass');
                    return element;
                } else {
                    this.addResult(name, 'fail', `√âl√©ment ${selector} non trouv√©`);
                    return null;
                }
            }

            testElementsExist(selectors, name) {
                const elements = selectors.map(sel => document.querySelector(sel));
                const missing = selectors.filter((sel, i) => !elements[i]);
                
                if (missing.length === 0) {
                    this.addResult(name, 'pass');
                    return elements;
                } else {
                    this.addResult(name, 'fail', `√âl√©ments manquants: ${missing.join(', ')}`);
                    return null;
                }
            }

            testFunctionExists(obj, funcName, name) {
                if (obj && typeof obj[funcName] === 'function') {
                    this.addResult(name, 'pass');
                    return true;
                } else {
                    this.addResult(name, 'fail', `Fonction ${funcName} non trouv√©e`);
                    return false;
                }
            }

            testClassExists(className, name) {
                try {
                    const instance = new window[className]();
                    this.addResult(name, 'pass');
                    return instance;
                } catch (error) {
                    this.addResult(name, 'fail', `Classe ${className} non disponible: ${error.message}`);
                    return null;
                }
            }

            addSectionHeader(title) {
                const resultsContainer = document.getElementById('test-results');
                const div = document.createElement('div');
                div.className = 'section-header';
                div.textContent = title;
                resultsContainer.appendChild(div);
            }
        }

        // Ex√©cution des tests
        document.addEventListener('DOMContentLoaded', async () => {
            const runner = new InterfaceTestRunner();
            
            // D√©finir le nombre total de tests
            runner.totalTests = 35;
            runner.updateProgress();

            console.log('üöÄ D√©marrage des tests d\'interface...');

            // === SECTION 1: STRUCTURE HTML ===
            runner.addSectionHeader('1. Structure HTML de Base');

            runner.testElementExists('#app', 'Container principal (#app)');
            runner.testElementExists('.app-header', 'En-t√™te application');
            runner.testElementExists('.app-main', 'Zone principale');
            runner.testElementExists('#invoice-container', 'Container de facture');
            runner.testElementExists('.invoice-preview', 'Zone de pr√©visualisation');
            runner.testElementExists('.invoice-controls', 'Zone de contr√¥les');

            // === SECTION 2: √âL√âMENTS DE PR√âVISUALISATION ===
            runner.addSectionHeader('2. √âl√©ments de Pr√©visualisation');

            runner.testElementsExist([
                '#company-name-display',
                '#company-address-display', 
                '#company-phone-display',
                '#company-email-display',
                '#company-logo-display'
            ], 'Affichage informations entreprise');

            runner.testElementsExist([
                '#invoice-number-display',
                '#invoice-date-display'
            ], 'Affichage informations facture');

            runner.testElementsExist([
                '#items-list',
                '#hourly-items-list',
                '.items-table',
                '.hourly-table'
            ], 'Tableaux d\'articles et prestations');

            runner.testElementsExist([
                '#subtotal-ht-display',
                '#total-discount-display',
                '#total-vat-display',
                '#total-ttc-display'
            ], 'Affichage des totaux');

            // === SECTION 3: CONTR√îLES DE SAISIE ===
            runner.addSectionHeader('3. Contr√¥les de Saisie');

            runner.testElementsExist([
                '#company-name',
                '#company-logo',
                '#company-address',
                '#company-phone',
                '#company-email',
                '#legal-info',
                '#invoice-number'
            ], 'Champs informations entreprise');

            runner.testElementsExist([
                '#item-reference',
                '#item-description',
                '#item-quantity',
                '#item-unit-price',
                '#item-discount',
                '#item-vat',
                '#add-item'
            ], 'Champs et bouton articles');

            runner.testElementsExist([
                '#hourly-description',
                '#hourly-hours',
                '#hourly-rate',
                '#add-hourly-item'
            ], 'Champs et bouton prestations horaires');

            // === SECTION 4: PERSONNALISATION ===
            runner.addSectionHeader('4. Contr√¥les de Personnalisation');

            runner.testElementsExist([
                '#currency-select',
                '#theme-select'
            ], 'S√©lecteurs devise et th√®me');

            runner.testElementsExist([
                '#text-color',
                '#background-color',
                '#primary-color',
                '#accent-color'
            ], 'S√©lecteurs de couleurs');

            runner.testElementsExist([
                '#header-font',
                '#body-font'
            ], 'S√©lecteurs de polices');

            runner.testElementExists('#uppercase-toggle', 'Toggle majuscules');

            runner.testElementsExist([
                '#col-reference-edit',
                '#col-description-edit',
                '#col-quantity-edit',
                '#col-unit-price-edit',
                '#col-discount-edit',
                '#col-vat-edit',
                '#col-total-edit'
            ], '√âditeurs de titres de colonnes');

            runner.testElementsExist([
                '#payment-method',
                '#footer-text'
            ], 'Champs mode de paiement et pied de page');

            // === SECTION 5: BOUTONS D'EXPORT ===
            runner.addSectionHeader('5. Fonctionnalit√©s d\'Export');

            runner.testElementsExist([
                '#export-pdf',
                '#export-jpg'
            ], 'Boutons d\'export');

            // === SECTION 6: CLASSES JAVASCRIPT ===
            runner.addSectionHeader('6. Classes JavaScript');

            const invoiceManager = runner.testClassExists('InvoiceManager', 'Classe InvoiceManager');
            const themeManager = runner.testClassExists('ThemeManager', 'Classe ThemeManager');
            const currencyManager = runner.testClassExists('CurrencyManager', 'Classe CurrencyManager');

            // === SECTION 7: FONCTIONS GLOBALES ===
            runner.addSectionHeader('7. Fonctions Globales');

            runner.testFunctionExists(window, 'getState', 'Fonction getState');
            runner.testFunctionExists(window, 'setState', 'Fonction setState');
            runner.testFunctionExists(window, 'updateState', 'Fonction updateState');
            runner.testFunctionExists(window, 'generateId', 'Fonction generateId');

            // === SECTION 8: CALCULATEURS ===
            runner.addSectionHeader('8. Calculateurs');

            runner.testClassExists('ItemCalculator', 'Classe ItemCalculator');
            runner.testClassExists('HourlyCalculator', 'Classe HourlyCalculator');
            runner.testClassExists('TotalCalculator', 'Classe TotalCalculator');

            // === SECTION 9: MOTEURS D'EXPORT ===
            runner.addSectionHeader('9. Moteurs d\'Export');

            const pdfEngine = runner.testClassExists('PDFEngine', 'Classe PDFEngine');
            const imageEngine = runner.testClassExists('ImageEngine', 'Classe ImageEngine');

            // === SECTION 10: TESTS FONCTIONNELS ===
            runner.addSectionHeader('10. Tests Fonctionnels');

            // Test de l'√©tat initial
            try {
                const state = getState();
                if (state && state.invoice && state.invoice.company && Array.isArray(state.invoice.items)) {
                    runner.addResult('√âtat initial valide', 'pass');
                } else {
                    runner.addResult('√âtat initial valide', 'fail', 'Structure d\'√©tat invalide');
                }
            } catch (error) {
                runner.addResult('√âtat initial valide', 'fail', error.message);
            }

            // Test des gestionnaires
            if (themeManager) {
                try {
                    const themes = themeManager.getAllThemes();
                    const themeCount = Object.keys(themes).length;
                    if (themeCount >= 5 && themeCount <= 10) {
                        runner.addResult('Nombre de th√®mes (5-10)', 'pass', `${themeCount} th√®mes disponibles`);
                    } else {
                        runner.addResult('Nombre de th√®mes (5-10)', 'warning', `${themeCount} th√®mes (attendu: 5-10)`);
                    }
                } catch (error) {
                    runner.addResult('Nombre de th√®mes (5-10)', 'fail', error.message);
                }
            }

            if (currencyManager) {
                try {
                    const currencies = currencyManager.getAllCurrencies();
                    const currencyCount = Object.keys(currencies).length;
                    if (currencyCount >= 30) {
                        runner.addResult('Devises ISO 4217', 'pass', `${currencyCount} devises disponibles`);
                    } else {
                        runner.addResult('Devises ISO 4217', 'warning', `${currencyCount} devises (attendu: ‚â•30)`);
                    }
                } catch (error) {
                    runner.addResult('Devises ISO 4217', 'fail', error.message);
                }
            }

            // Test de formatage des devises
            if (currencyManager) {
                try {
                    const formatted = currencyManager.formatAmount(1234.56);
                    if (typeof formatted === 'string' && formatted.includes('‚Ç¨')) {
                        runner.addResult('Formatage des devises', 'pass', `Exemple: ${formatted}`);
                    } else {
                        runner.addResult('Formatage des devises', 'fail', 'Format invalide');
                    }
                } catch (error) {
                    runner.addResult('Formatage des devises', 'fail', error.message);
                }
            }

            // === R√âSUM√â FINAL ===
            runner.displaySummary();
            
            const passed = runner.results.filter(r => r.status === 'pass').length;
            const failed = runner.results.filter(r => r.status === 'fail').length;
            const warnings = runner.results.filter(r => r.status === 'warning').length;
            
            console.log(`‚úÖ Tests termin√©s: ${passed} r√©ussis, ${failed} √©chou√©s, ${warnings} avertissements`);
            
            if (failed === 0) {
                if (warnings === 0) {
                    console.log('üéâ Interface compl√®tement fonctionnelle!');
                    document.title = '‚úÖ Interface Compl√®te - Tous les tests pass√©s';
                } else {
                    console.log('‚ö†Ô∏è Interface fonctionnelle avec quelques avertissements');
                    document.title = '‚ö†Ô∏è Interface Compl√®te - Avertissements';
                }
            } else {
                console.log('‚ùå Interface incompl√®te - certains √©l√©ments manquent');
                document.title = '‚ùå Interface Incompl√®te - Erreurs d√©tect√©es';
            }

            // Afficher les recommandations
            if (failed > 0 || warnings > 0) {
                const resultsContainer = document.getElementById('test-results');
                const recommendationsDiv = document.createElement('div');
                recommendationsDiv.className = 'section-header';
                recommendationsDiv.innerHTML = `
                    <strong>Recommandations:</strong><br>
                    ${failed > 0 ? `‚Ä¢ ${failed} √©l√©ments critiques manquent et doivent √™tre impl√©ment√©s<br>` : ''}
                    ${warnings > 0 ? `‚Ä¢ ${warnings} √©l√©ments pourraient √™tre am√©lior√©s<br>` : ''}
                    ‚Ä¢ V√©rifiez que tous les scripts sont correctement charg√©s<br>
                    ‚Ä¢ Testez les fonctionnalit√©s interactives manuellement
                `;
                resultsContainer.appendChild(recommendationsDiv);
            }
        });
    </script>
</body>
</html>